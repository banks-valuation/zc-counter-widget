<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dynamic Record Counter</title>
  <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h3>Widget Version: <span id="widgetVersion"></span></h3>
  <h2>Count: <span id="recordCount">0</span></h2>

  <script>
    // Helper function with retry logic
    async function safeGetRecordCount(config, retry = 0) {
      try {
        const response = await ZOHO.CREATOR.DATA.getRecordCount(config);
        return response.result.records_count;
      } catch (err) {
        console.warn("Record count error:", err);

        // retry only if session expired or config lost
        const isTransient =
          String(err).includes("INVALID_OAUTH") ||
          String(err).includes("UNAUTHORIZED") ||
          String(err).includes("Improper Configuration");

        if (isTransient && retry < 3) {
          console.log("Retrying after reinitializing Zoho Creator...");
          await new Promise(res => setTimeout(res, 2000));
          try { await ZOHO.CREATOR.init(); } catch(e) {}
          return safeGetRecordCount(config, retry + 1);
        }

        throw err;
      }
    }

    // Main logic
    ZOHO.CREATOR.UTIL.getQueryParams().then(function(params) {
      const reportName = params.report_name;
      const criteria = params.criteria;

      async function updateCount() {
        const config = {
          app_name: "echo",
          report_name: reportName,
          criteria: criteria
        };

        try {
          const count = await safeGetRecordCount(config);
          $("#recordCount").text(count);
        } catch (err) {
          console.error("Final failure:", err);
        }
      }

      // Initial fetch
      updateCount();

      // Show widget version
      document.getElementById("widgetVersion").textContent =
        new Date(document.lastModified).toLocaleString();

      // Refresh every 5 seconds
      setInterval(updateCount, 5000);
    });
  </script>
</body>
</html>
