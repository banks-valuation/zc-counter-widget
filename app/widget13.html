<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Count Dashboard Widget</title>
  <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    .count-box {
      display: inline-block; margin: 8px; padding: 10px 16px;
      border-radius: 10px; background: #f2f2f2; min-width: 100px;
    }
    .label { font-size: 14px; color: #555; }
    .value { font-size: 22px; font-weight: bold; color: #003366; }
  </style>
</head>
<body>
  <h3>Widget Version: <span id="widgetVersion"></span></h3>
  <div id="countsContainer"></div>

  <script>
    const nowISO = new Date().toISOString().slice(0, 19).replace("T", " "); 

    const widgetConfig = [
      { id: "draft", label: "Draft", report: "Order_Offers", criteria: '(Status.Status_Code=="OO-0.0-ENTRY")' },
      { id: "draft_late", label: "Draft Late", report: "Order_Offers", criteria: `(Status.Status_Code=="OO-0.0-ENTRY" && Response_Required_By_Date < "${nowISO}")`  },
      { id: "new", label: "New", report: "Order_Offers", criteria: '(Status.Status_Code=="OO-1.0-NEW")' },
      { id: "offered", label: "Offered", report: "Order_Offers", criteria: '(Status.Status_Code=="OO-1.5-OFFEREDTOAPPRAISER")' },
      { id: "accepted", label: "Accepted", report: "Order_Offers", criteria: '(Status.Status_Code=="OO-2.0-ACCEPTED")' },
      { id: "declined", label: "Declined", report: "Order_Offers", criteria: '(Status.Status_Code=="OO-2.5-REJECTED")' }
    ];

    // --- DOM setup ---
    const container = $("#countsContainer");
    widgetConfig.forEach(cfg => {
      container.append(`
        <div class="count-box">
          <div class="label">${cfg.label}</div>
          <div class="value" id="${cfg.id}">--</div>
        </div>
      `);
    });
    document.getElementById("widgetVersion").textContent =
      new Date(document.lastModified).toLocaleString();

    // --- Wait for API readiness ---
    async function waitForAPI(timeout = 7000, interval = 200) {
      const start = Date.now();
      while (!ZOHO?.CREATOR?.DATA?.getRecordCount) {
        if (Date.now() - start > timeout) {
          console.error("Timed out waiting for ZOHO.CREATOR.DATA.getRecordCount");
          return false;
        }
        await new Promise(r => setTimeout(r, interval));
      }
      return true;
    }

    // --- Safe SDK init ---
    async function safeInit(retries = 5, delay = 3000) {
      for (let i = 0; i < retries; i++) {
        try {
          await ZOHO.CREATOR.UTIL.getInitParams();
          console.log("ZOHO SDK initialized successfully.");
          return true;
        } catch (err) {
          console.warn(`Init attempt ${i+1} failed, retrying in ${delay/1000}s...`, err);
          await new Promise(r => setTimeout(r, delay));
        }
      }
      console.error("ZOHO SDK failed to initialize after multiple attempts.");
      return false;
    }

    // --- Safe getRecordCount with retries ---
    async function safeGetRecordCount(cfg, retries = 3, delay = 2000) {
      for (let i = 0; i < retries; i++) {
        try {
          if (!ZOHO?.CREATOR?.DATA?.getRecordCount) {
            console.warn("API not ready, waiting...");
            const ready = await waitForAPI(7000);
            if (!ready) throw new Error("ZOHO API never became ready");
          }

          const response = await ZOHO.CREATOR.DATA.getRecordCount({
            report_name: cfg.report,
            criteria: cfg.criteria
          });
          return response.count ?? response.result?.records_count ?? 0;

        } catch (err) {
          console.warn(`Attempt ${i+1} for ${cfg.label} failed:`, err);
          if (String(err).includes("Invalid Ticket Id") || String(err).includes("SESSION")) {
            await safeInit();
          }
          await new Promise(r => setTimeout(r, delay));
        }
      }
      console.error(`Failed to fetch count for ${cfg.label} after ${retries} attempts.`);
      return "--";
    }

    // --- Main count updater ---
    async function updateAllCounts() {
      for (const cfg of widgetConfig) {
        const count = await safeGetRecordCount(cfg);
        $("#" + cfg.id).text(count);
      }
    }

    // --- Boot sequence ---
    (async () => {
      const initOk = await safeInit();
      if (!initOk) return;

      const apiReady = await waitForAPI();
      if (!apiReady) return;

      await updateAllCounts();
      setInterval(updateAllCounts, 5000); // update every 5s
    })();
  </script>
</body>
</html>
