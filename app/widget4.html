<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Order Entry Counter</title>
  <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 30px;
    }
    #orderCount {
      font-size: 2em;
      font-weight: bold;
    }
    .error {
      color: red;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h3>Widget Version: <span id="widgetVersion"></span></h3>

  <h2>Orders in Entry Status: <span id="orderCount">0</span></h2>
  <div id="errorMsg" class="error"></div>

  <script>
    // ---- CONFIGURATION ----
    const CONFIG = {
      app_name: "echo",
      report_name: "Order_Offers",
      criteria: '(Status.Status_Code = "OO-0.0-ENTRY")'
    };

    // ---- HELPER: resilient data fetch ----
    async function safeGetRecordCount(config, retry = 0) {
      try {
        const response = await ZOHO.CREATOR.DATA.getRecordCount(config);
        $("#errorMsg").text("");
        return response.result.records_count;
      } catch (err) {
        console.warn("Record count error:", err);

        // Detect auth/session expiration
        const errorText = JSON.stringify(err);
        const likelyExpired =
          errorText.includes("INVALID_OAUTH") ||
          errorText.includes("UNAUTHORIZED") ||
          err.status === 401;

        if (likelyExpired && retry < 3) {
          $("#errorMsg").text("Session expired â€” retrying...");
          console.log("Retrying after 2s...");
          await new Promise((res) => setTimeout(res, 2000));
          return safeGetRecordCount(config, retry + 1);
        }

        $("#errorMsg").text("Unable to fetch data. Please refresh the page.");
        throw err;
      }
    }

    // ---- MAIN FUNCTION ----
    async function updateCount() {
      try {
        const count = await safeGetRecordCount(CONFIG);
        $("#orderCount").text(count);
      } catch (e) {
        console.error("Final failure:", e);
      }
    }

    // ---- INITIALIZATION ----
    document.getElementById("widgetVersion").textContent =
      new Date(document.lastModified).toLocaleString();

    // Fetch immediately, then every 5s
    updateCount();
    setInterval(updateCount, 5000);
  </script>
</body>
</html>
