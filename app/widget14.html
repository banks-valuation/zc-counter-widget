<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Count Dashboard Widget</title>
  <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    .count-box {
      display: inline-block; margin: 8px; padding: 10px 16px;
      border-radius: 10px; background: #f2f2f2; min-width: 100px;
    }
    .label { font-size: 14px; color: #555; }
    .value { font-size: 22px; font-weight: bold; color: #003366; }
  </style>
</head>
<body>
  <h3>Widget Version: <span id="widgetVersion"></span></h3>
  <div id="countsContainer"></div>

  <script>
    const currentTime = new Date().toISOString().slice(0, 19).replace("T", " "); 

    const base = new Date(); // current moment
    const todayDate = new Date(base); // clone
    const yesterdayDate = new Date(base);
    const tomorrowDate = new Date(base);
    const twoDaysFromTodayDate = new Date(base);

    yesterdayDate.setDate(base.getDate() - 1);
    todayDate.setDate(base.getDate());
    tomorrowDate.setDate(base.getDate() + 1);
    twoDaysFromTodayDate.setDate(base.getDate() + 2);

    const yesterday = yesterdayDate.toISOString().slice(0, 10);
    const today = todayDate.toISOString().slice(0, 10);
    const tomorrow = tomorrowDate.toISOString().slice(0, 10);
    const twoDaysFromToday = twoDaysFromTodayDate.toISOString().slice(0, 10);


    // to get the configuration, call this API endpoint: https://www.zohoapis.com/creator/custom/banksvaluation/getDashboardConfig
    const configResp = await fetch("https://www.zohoapis.com/creator/custom/banksvaluation/getDashboardConfig?dashboardName=Intake_and_Assignment_Dashboard&publickey=MaF7uhAWE5r1ZZm3DSA9tGN7V");
    const config = await configResp.json();

    // Flatten out the nested structure into widgetConfig
    const widgetConfig = [];

    if (config?.result?.length) {
      config.result.forEach(section => {
        if (Array.isArray(section.counterList)) {
          section.counterList.forEach(counter => {
            if (counter?.count && counter?.id && counter?.label) {
              // Replace placeholders like ${today} with actual values
              const criteria = counter.count
                .replaceAll("${today}", today)
                .replaceAll("${tomorrow}", tomorrow)
                .replaceAll("${twoDaysFromToday}", twoDaysFromToday)
                .replaceAll("${currentTime}", currentTime)
                .replaceAll("`", ""); // remove backticks

              const report = (counter.report || "").replaceAll('"', "").replaceAll("+", "").trim();

              widgetConfig.push({
                id: counter.id.replace(/\s+/g, "_"), // sanitize id for DOM
                label: counter.label,
                report: report || "Unknown_Report",
                criteria
              });
            }
          });
        }
      });
    }


    // --- DOM setup ---
    const container = $("#countsContainer");
    widgetConfig.forEach(cfg => {
      container.append(`
        <div class="count-box">
          <div class="label">${cfg.label}</div>
          <div class="value" id="${cfg.id}"><a href="#Report:${cfg.report}" target="report">--</a></div>
        </div>
      `);
    });
    document.getElementById("widgetVersion").textContent =
      new Date(document.lastModified).toLocaleString();

    // --- Wait for API readiness ---
    async function waitForAPI(timeout = 7000, interval = 200) {
      const start = Date.now();
      while (!ZOHO?.CREATOR?.DATA?.getRecordCount) {
        if (Date.now() - start > timeout) {
          console.error("Timed out waiting for ZOHO.CREATOR.DATA.getRecordCount");
          return false;
        }
        await new Promise(r => setTimeout(r, interval));
      }
      return true;
    }

    // --- Safe SDK init ---
    async function safeInit(retries = 5, delay = 3000) {
      for (let i = 0; i < retries; i++) {
        try {
          await ZOHO.CREATOR.UTIL.getInitParams();
          console.log("ZOHO SDK initialized successfully.");
          return true;
        } catch (err) {
          console.warn(`Init attempt ${i+1} failed, retrying in ${delay/1000}s...`, err);
          await new Promise(r => setTimeout(r, delay));
        }
      }
      console.error("ZOHO SDK failed to initialize after multiple attempts.");
      return false;
    }

    // --- Safe getRecordCount with retries ---
    async function safeGetRecordCount(cfg, retries = 3, delay = 2000) {
      for (let i = 0; i < retries; i++) {
        try {
          if (!ZOHO?.CREATOR?.DATA?.getRecordCount) {
            console.warn("API not ready, waiting...");
            const ready = await waitForAPI(7000);
            if (!ready) throw new Error("ZOHO API never became ready");
          }

          const response = await ZOHO.CREATOR.DATA.getRecordCount({
            report_name: cfg.report,
            criteria: cfg.criteria
          });
          return response.count ?? response.result?.records_count ?? 0;

        } catch (err) {
          console.warn(`Attempt ${i+1} for ${cfg.label} failed:`, err);
          if (String(err).includes("Invalid Ticket Id") || String(err).includes("SESSION")) {
            await safeInit();
          }
          await new Promise(r => setTimeout(r, delay));
        }
      }
      console.error(`Failed to fetch count for ${cfg.label} after ${retries} attempts.`);
      return "--";
    }

    // --- Main count updater ---
    async function updateAllCounts() {
      for (const cfg of widgetConfig) {
        const count = await safeGetRecordCount(cfg);
        $("#" + cfg.id).text(count);
      }
    }

    // --- Boot sequence ---
    (async () => {
      const initOk = await safeInit();
      if (!initOk) return;

      const apiReady = await waitForAPI();
      if (!apiReady) return;

      await updateAllCounts();
      setInterval(updateAllCounts, 5000); // update every 5s
    })();
  </script>
</body>
</html>
