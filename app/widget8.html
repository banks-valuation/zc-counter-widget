<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Count Dashboard Widget</title>
  <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    .count-box {
      display: inline-block; margin: 8px; padding: 10px 16px;
      border-radius: 10px; background: #f2f2f2; min-width: 100px;
    }
    .label { font-size: 14px; color: #555; }
    .value { font-size: 22px; font-weight: bold; color: #003366; }
  </style>
</head>
<body>
  <h3>Widget Version: <span id="widgetVersion"></span></h3>

  <div id="countsContainer"></div>

  <script>
    const widgetConfig = [
      { id: "draft", label: "Draft", report: "Orders_Report", criteria: '(Status.Status_Code="OO-0.0-ENTRY")' },
      { id: "new", label: "New", report: "Orders_Report", criteria: '(Status.Status_Code="OO-1.0-NEW")' },
      { id: "offered", label: "Offered", report: "Orders_Report", criteria: '(Status.Status_Code="OO-1.5-OFFEREDTOAPPRAISER")' },
      { id: "accepted", label: "Accepted", report: "Orders_Report", criteria: '(Status.Status_Code="OO-2.0-ACCEPTED")' },
      { id: "declined", label: "Declined", report: "Orders_Report", criteria: '(Status.Status_Code="OO-2.5-REJECTED")' }
    ];

    // --- DOM setup ---
    const container = $("#countsContainer");
    widgetConfig.forEach(cfg => {
      container.append(`
        <div class="count-box">
          <div class="label">${cfg.label}</div>
          <div class="value" id="${cfg.id}">--</div>
        </div>
      `);
    });

    document.getElementById("widgetVersion").textContent =
      new Date(document.lastModified).toLocaleString();

    // --- Safe SDK initialization ---
    async function safeInit(retries = 5, delay = 3000) {
      for (let i = 0; i < retries; i++) {
        try {
          await ZOHO.CREATOR.UTIL.getInitParams();
          console.log("ZOHO SDK initialized successfully.");
          return true;
        } catch (err) {
          console.warn(`Init attempt ${i+1} failed, retrying in ${delay/1000}s...`, err);
          await new Promise(r => setTimeout(r, delay));
        }
      }
      console.error("ZOHO SDK failed to initialize after multiple attempts.");
      return false;
    }

    // --- Safe getRecordCount wrapper ---
    async function safeGetRecordCount(cfg, retries = 3, delay = 2000) {
      for (let i = 0; i < retries; i++) {
        try {
          if (!ZOHO?.CREATOR?.API?.getRecordCount) {
            console.warn("API not ready, waiting...");
            await safeInit();
          }
          const response = await ZOHO.CREATOR.API.getRecordCount({
            appName: "echo",
            reportName: cfg.report,
            criteria: cfg.criteria
          });
          const count = response.count ?? response.result?.records_count ?? 0;
          return count;
        } catch (err) {
          console.warn(`Attempt ${i+1} for ${cfg.label} failed:`, err);
          if (String(err).includes("Invalid Ticket Id") || String(err).includes("SESSION")) {
            await safeInit();
          }
          await new Promise(r => setTimeout(r, delay));
        }
      }
      console.error(`Failed to fetch count for ${cfg.label} after ${retries} attempts.`);
      return "--";
    }

    // --- Main count updater ---
    async function updateAllCounts() {
      for (const cfg of widgetConfig) {
        const count = await safeGetRecordCount(cfg);
        $("#" + cfg.id).text(count);
      }
    }

    // --- Boot sequence ---
    (async () => {
      const initOk = await safeInit();
      if (!initOk) return;

      await updateAllCounts();
      setInterval(updateAllCounts, 5000);
    })();
  </script>
</body>
</html>
