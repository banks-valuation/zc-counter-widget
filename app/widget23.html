<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard Count Update Widget</title>
  <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
</head>
<body>
  <script>
    const currentTime = new Date().toISOString().slice(0, 19).replace("T", " "); 

    const base = new Date(); // current moment
    const todayDate = new Date(base); // clone
    const yesterdayDate = new Date(base);
    const tomorrowDate = new Date(base);
    const twoDaysFromTodayDate = new Date(base);

    yesterdayDate.setDate(base.getDate() - 1);
    todayDate.setDate(base.getDate());
    tomorrowDate.setDate(base.getDate() + 1);
    twoDaysFromTodayDate.setDate(base.getDate() + 2);

    const yesterday = yesterdayDate.toISOString().slice(0, 10);
    const today = todayDate.toISOString().slice(0, 10);
    const tomorrow = tomorrowDate.toISOString().slice(0, 10);
    const twoDaysFromToday = twoDaysFromTodayDate.toISOString().slice(0, 10);

    let creatorScope = "";
    let creatorAppLinkName = "";    

    // --- Safe SDK init ---
    async function safeInit(retries = 5, delay = 3000) {
      for (let i = 0; i < retries; i++) {
        try {
          await ZOHO.CREATOR.UTIL.getInitParams().then(function(initParams) {
            console.log("Init Params:", initParams);
          // save values for later
          creatorScope = initParams.scope;
          creatorAppLinkName = initParams.appLinkName;            
          });
          console.log("ZOHO SDK initialized successfully.");
          return true;
        } catch (err) {
          console.warn(`Init attempt ${i+1} failed, retrying in ${delay/1000}s...`, err);
          await new Promise(r => setTimeout(r, delay));
        }
      }
      console.error("ZOHO SDK failed to initialize after multiple attempts.");
      return false;
    }

    // --- Wait for API readiness ---
    async function waitForAPI(timeout = 7000, interval = 200) {
      const start = Date.now();
      while (!ZOHO?.CREATOR?.DATA?.getRecordCount) {
        if (Date.now() - start > timeout) {
          console.error("Timed out waiting for ZOHO.CREATOR.DATA.getRecordCount");
          return false;
        }
        await new Promise(r => setTimeout(r, interval));
      }
      return true;
    }
    
    // --- Utility function to format datetime ---
    function toZohoDateTimeString(date) {
      const pad = (n) => (n < 10 ? "0" + n : n);
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    // --- Wait helper ---
    const wait = (ms) => new Promise((r) => setTimeout(r, ms));

    // --- Safe getRecordCount with retries ---
    async function safeGetRecordCount(reportName, criteria, retries = 3, delay = 1500) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await ZOHO.CREATOR.DATA.getRecordCount({
            report_name: reportName,
            criteria: criteria
          });
          return response.count ?? response.result?.records_count ?? 0;
        } catch (err) {
          console.warn(`Attempt ${i + 1} failed for ${reportName}`, err);
          await wait(delay);
        }
      }
      return "--";
    }

    // --- Fetch dynamic config from your Zoho API ---
    async function fetchDashboardConfig() {
      const customApiConfig = {
        api_name: "getDashboardConfig",
        content_type: "application/json",
        http_method: "GET",
        public_key: "MaF7uhAWE5r1ZZm3DSA9tGN7V", 
        query_params: "dashboardName=Intake_and_Assignment_Dashboard"
      };

      try {
        const dashConfigResp = await ZOHO.CREATOR.DATA.invokeCustomApi(customApiConfig);
        console.log("Dashboard Config:", dashConfigResp);
        const result = dashConfigResp?.data?.result || dashConfigResp?.result;
        if (!result || result.length === 0) {
            console.error("No valid widget configuration found.");
            return [];
        }        
        // Flatten all counterLists into one array for easy iteration
        const widgetConfig = result
            .map(section => section.counterList)
            .flat()
            .filter(counter => counter.id && counter.label); // only include valid counters

        console.log("Dashboard Config loaded:", widgetConfig);
        return widgetConfig;
        
      } catch (err) {
        console.error("Failed to fetch dashboard config:", err);
        return null;
      }
    }

    // --- Update all counters on parent page ---
    async function updateAllCounts(config) {
      const now = toZohoDateTimeString(new Date());
      for (const cfg of config) {
        // Replace date placeholders in criteria (if any)
        let criteria = cfg.criteria || "";
        criteria = criteria.replace(/\$\{currentTime\}/g, now)
                           .replace(/\$\{today\}/g, now.slice(0, 10));

        const count = await safeGetRecordCount(cfg.report, criteria);
        try {
          const el = parent.document.getElementById(cfg.id);
          if (el) el.textContent = count;
          else console.warn(`Element not found for ID: ${cfg.id}`);
        } catch (err) {
          console.error("Unable to access parent document:", err);
        }
      }
    }


    // --- Init sequence ---
    (async () => {
      console.log("Initializing Zoho Creator Widget.  Version: " + new Date(document.lastModified).toLocaleString());
      const initOk = await safeInit();
      if (!initOk) return;

      console.log("Waiting for API readiness...");
      const apiReady = await waitForAPI();
      if (!apiReady) return;

      console.log("Fetching dashboard configuration...");
      const widgetConfig = await fetchDashboardConfig();
      console.log("Widget Configuration:", widgetConfig);

      console.log("Starting count updates...");
      await updateAllCounts(widgetConfig);
      setInterval(() => updateAllCounts(widgetConfig), 5000);
    })();

  </script>
</body>
</html>
